pipeline 
{
	agent any
    
//    environment { 
//        JenkinsBase = 'jenkins/test/'
//    }
       
	stages { 
		stage('Initialize') 
		{
			
            
			steps {
				timestamps {
					ansiColor('xterm') {
						
						slackSend (color: '#FFFF00', message: "STARTED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})")
										
						dir('build')
						{
							deleteDir()
						}	

						dir('coresoftware') {
							deleteDir()
						}
						dir('online_distribution') {
							deleteDir()
						}
						dir('macros')
						{
							deleteDir()
    				}	
						dir('calibrations')
						{
							deleteDir()
    				}	
						dir('tutorials')
						{
							deleteDir()
    				}
					
						sh('hostname')
						sh('pwd')
						sh('env')
						sh('ls -lvhc')

						dir('utilities/jenkins/built-test/') {
							
							sh('/usr/bin/singularity exec -B /var/lib/jenkins/singularity/cvmfs:/cvmfs -B /gpfs -B /direct -B /afs -B /sphenix /var/lib/jenkins/singularity/cvmfs/sphenix.sdcc.bnl.gov/singularity/rhic_sl7_ext.simg tcsh -f singularity-check.sh')
						
						}
					}
				}
			}
		}

		stage('Git Checkout')
		{
			
			steps 
			{
				timestamps { 
					ansiColor('xterm') {
						
						dir('coresoftware') {
							git credentialsId: 'sPHENIX-bot', url: 'https://github.com/sPHENIX-Collaboration/coresoftware.git'
						}
						dir('online_distribution') {
							git credentialsId: 'sPHENIX-bot', url: 'https://github.com/sPHENIX-Collaboration/online_distribution.git'
						}
						//dir('macros')
						//{
						//	git credentialsId: 'sPHENIX-bot', url: 'https://github.com/sPHENIX-Collaboration/macros.git'
    				//}	
						dir('calibrations')
						{
							git credentialsId: 'sPHENIX-bot', url: 'https://github.com/sPHENIX-Collaboration/calibrations.git'
    				}	
						dir('tutorials')
						{
							git credentialsId: 'sPHENIX-bot', url: 'https://github.com/sPHENIX-Collaboration/tutorials.git'
    				}
					}
				}
			}
		}//stage('SCM Checkout')
		
		stage('cpp-check')
		{
			
			steps 
			{

    		build(job: 'cpp-check',
    			parameters:
    			[string(name: 'coresoftware_src', value: "${WORKSPACE}/coresoftware")], 
    			wait: false, propagate: false)
   		}
		}
		 
		stage('Build')
		{
			
			steps 
			{
				dir('build') {
					deleteDir()
				}
				sh('hostname')
				sh('pwd')
				sh('env')
				sh('ls -lvhc')
						
				sh('/usr/bin/singularity exec -B /var/lib/jenkins/singularity/cvmfs:/cvmfs -B /gpfs -B /direct -B /afs -B /sphenix /var/lib/jenkins/singularity/cvmfs/sphenix.sdcc.bnl.gov/singularity/rhic_sl7_ext.simg tcsh -f utilities/jenkins/built-test/full-build.sh')
			
			 	script {
			  	build_root_path = pwd();
			 	}
						
				slackSend (color: '#00F000', message: "sPHENIX build available: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL}). Buld available at ${build_root_path}")
			}										
		}
		
		stage('Test')
		{
			parallel {
			
				stage('test-default')
				{
					
					steps 
					{
						//sh('/usr/bin/singularity exec -B /var/lib/jenkins/singularity/cvmfs:/cvmfs -B /gpfs -B /direct -B /afs -B /sphenix /var/lib/jenkins/singularity/cvmfs/sphenix.sdcc.bnl.gov/singularity/rhic_sl7_ext.simg tcsh -f utilities/jenkins/built-test/test-default.sh')
						
		    		build(job: 'test-default',
		    			parameters:
		    			[string(name: 'build_src', value: "${build_root_path}")], 
		    			wait: true, propagate: true)
		   										
		   			copyArtifacts(projectName: 'test-default');
		   			
		   			dir('macros/macros/g4simulations/')
		   			{
		   				stash name: "test-default-stash", includes: "*"
		   			}
		   			
		   			dir('test-default-output')
		   			{
		   				unstash "test-default-stash"
		   				archiveArtifacts artifacts: '*', onlyIfSuccessful: true	
		   			}
		   				    
					}				
				}
			
				stage('test-calo-single-qa')
				{
					
					steps 
					{
						
		    		build(job: 'test-calo-single-qa',
		    			parameters:
		    			[string(name: 'build_src', value: "${build_root_path}")], 
		    			wait: true, propagate: true)
		   			
		   			copyArtifacts(projectName: 'test-calo-single-qa');
		   			
		   			
		   			dir('macros/macros/g4simulations/')
		   			{
		   				stash name: "test-calo-single-qa-stash", includes: "*"
		   			}
		   			
		   			dir('test-calo-single-qa-output')
		   			{
		   				unstash "test-calo-single-qa-stash"
		   				archiveArtifacts artifacts: '*', onlyIfSuccessful: true	
		   			}    
		   			
					}				
				}
				
				
			}// parallel			
		}
		
	}//stages
	
	
	
	post {
		always{
			archiveArtifacts artifacts: 'build/new/rebuild.log'
		}
	
		success {
			slackSend (color: '#00FF00', message: "SUCCESSFUL: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})")
		}
		failure {
			slackSend (color: '#FF0000', message: "FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})")
		}
		unstable {
			slackSend (color: '#FFF000', message: "UNSTABLE: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})")
		}
	}
	
}//pipeline 

